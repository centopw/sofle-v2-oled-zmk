name: Build and Release ZMK Firmware

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# Prevent multiple builds from running simultaneously
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # Required for creating releases
  actions: read    # Required for downloading artifacts

jobs:
  build:
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main
    
  release:
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      (github.event_name == 'workflow_dispatch')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Debug release conditions
        run: |
          echo "🔍 Release Job Debug Information:"
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          
          if [[ "${{ github.ref_name }}" != "main" && "${{ github.ref_name }}" != "master" ]]; then
            echo "⚠️  WARNING: Creating release from non-main branch (${{ github.ref_name }})"
            echo "This is allowed for manual testing but not recommended for production"
          fi
          
      - name: Get current date and time
        id: date
        run: |
          echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "readable_date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Prepare release assets
        run: |
          mkdir -p release_assets
          # Find and rename .uf2 files with clearer names
          find artifacts -name "sofle_left-*.uf2" -exec cp {} release_assets/LEFT-sofle_left-nice_nano_v2-zmk.uf2 \;
          find artifacts -name "sofle_right-*.uf2" -exec cp {} release_assets/RIGHT-sofle_right-nice_nano_v2-zmk.uf2 \;
          find artifacts -name "settings_reset-*.uf2" -exec cp {} release_assets/RESET-settings_reset-nice_nano_v2-zmk.uf2 \;
          # List what we found
          echo "Found firmware files:"
          ls -la release_assets/
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: firmware-${{ github.ref_name }}-${{ steps.date.outputs.timestamp }}
          name: ZMK Firmware Build (${{ github.ref_name }}) - ${{ steps.date.outputs.readable_date }}
          body: |
            ## ZMK Firmware Build
            
            **Build Date:** ${{ steps.date.outputs.readable_date }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            
            ### Included Firmware Files:
            - `LEFT-sofle_left-nice_nano_v2-zmk.uf2` - **Flash to LEFT side** (has ZMK Studio support)
            - `RIGHT-sofle_right-nice_nano_v2-zmk.uf2` - **Flash to RIGHT side**
            - `RESET-settings_reset-nice_nano_v2-zmk.uf2` - **Settings reset utility** (flash to either side to reset)
            
            ### Installation Instructions:
            1. Download the appropriate `.uf2` file for each side of your keyboard
            2. Put your keyboard into bootloader mode (double-tap reset)
            3. Copy the `.uf2` file to the USB drive that appears
            4. The keyboard will automatically reboot with the new firmware
            
            **Note:** Flash the left side first (with ZMK Studio support), then the right side.
          files: release_assets/*.uf2
          draft: false
          prerelease: false
