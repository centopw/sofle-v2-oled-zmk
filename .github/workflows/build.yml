name: Build and Release ZMK Firmware

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# Prevent multiple builds from running simultaneously
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # Required for creating releases
  actions: read    # Required for downloading artifacts

jobs:
  build:
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main
    
  release:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Get current date and time
        id: date
        run: |
          echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "readable_date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Prepare release assets
        run: |
          mkdir -p release_assets
          # Find and copy all .uf2 files to release assets
          find artifacts -name "*.uf2" -exec cp {} release_assets/ \;
          # List what we found
          echo "Found firmware files:"
          ls -la release_assets/
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: firmware-${{ steps.date.outputs.timestamp }}
          name: ZMK Firmware Build - ${{ steps.date.outputs.readable_date }}
          body: |
            ## ZMK Firmware Build
            
            **Build Date:** ${{ steps.date.outputs.readable_date }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            
            ### Included Firmware Files:
            - `sofle_left-nice_nano_v2-zmk.uf2` - Left side with ZMK Studio support
            - `sofle_right-nice_nano_v2-zmk.uf2` - Right side
            - `settings_reset-nice_nano_v2-zmk.uf2` - Settings reset utility
            
            ### Installation Instructions:
            1. Download the appropriate `.uf2` file for each side of your keyboard
            2. Put your keyboard into bootloader mode (double-tap reset)
            3. Copy the `.uf2` file to the USB drive that appears
            4. The keyboard will automatically reboot with the new firmware
            
            **Note:** Flash the left side first (with ZMK Studio support), then the right side.
          files: release_assets/*.uf2
          draft: false
          prerelease: false
